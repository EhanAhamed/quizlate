<!doctype html>
<html lang="en">
  <!--
    Quizfreely
    Copyright (c) Ehan Ahamed and contributors
    Licensed under the UPL-1.0 License
    https://quizfreely.com/LICENSE.txt
  -->

  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=10, user-scalable=1"
    />
    <eta> if (data.studyset) { </eta>
    <title><eta>= data.studyset.title </eta> - Quizfreely</title>
    <eta> } else { </eta>
    <title>Quizfreely Review Mode</title>
    <eta> } </eta>
    <link rel="icon" href="/favicon.ico" sizes="32x32">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <eta>~ data.themeCss </eta>
    <link rel="stylesheet" href="/assets/fonts/fonts.css" />
    <link
      rel="stylesheet"
      href="/assets/nerdfonts/webfont.css"
    />
  </head>

  <body>
    <eta>~ include("./partials/body-start", { theme: data.theme }) </eta>
    <eta>~ include("./partials/navbar", { page: "studyset", authed: data.authed, authedUser: data.authedUser }) </eta>
    <eta> if (data.local) {</eta>
    <eta>~ include("./partials/noscript") </eta>
    <eta> } </eta>
    <main>
      <div class="grid page">
        <div class="content">
          <eta> if (data?.reorderedTerms?.length >= 1) { </eta>
          <eta> data.reorderedTerms.forEach(function (term) { </eta>
          <div class="card"><eta>= term[0] </eta></div>
          <div class="flex">
            <button class="box"><eta>= term[1] </eta></button>
            <button class="box"><eta>= data.studyset.terms[] </eta></button>
          </div>
          <eta> }) </eta>
          <eta> } </eta>
        </div>
      </div>
    </main>
    <eta>~ include("./partials/footer") </eta>
    <eta> if (data.local) {</eta>
    <script src="/assets/js/indexedDB.js"></script>
    <script>
      openIndexedDB(function (db) {
        var studysetsObjectStore = db.transaction(["studysets"]).objectStore("studysets");
        var dbGetReq = studysetsObjectStore.get(<eta>= data.localId </eta>);
        dbGetReq.onerror = function (event) {
          alert("oopsie woopsie, indexeddb error");
        }
        dbGetReq.onsuccess = function (event) {
          if (dbGetReq.result) {
            if (dbGetReq.result.title) {
              document.getElementById("studyset-title").innerText = dbGetReq.result.title;
            }
            if (dbGetReq.result.data && dbGetReq.result.data.terms) {
              var termsTable = document.getElementById("terms-table");
              for (var i = 0; i < dbGetReq.result.data.terms.length; i++) {
                var newRow = termsTable.insertRow();
                var newCell0 = newRow.insertCell();
                var newCell1 = newRow.insertCell();
                newCell0.innerText = dbGetReq.result.data.terms[i][0];
                newCell0.style.whiteSpace = "pre-line";
                newCell1.innerText = dbGetReq.result.data.terms[i][1];
                newCell1.style.whiteSpace = "pre-line";
              }
              flashcardsChange();
            }
          } else {
            alert("studyset not found :(")
          }
        }
      })
      document.getElementById("delete-confirm-button").addEventListener("click", function () {
        openIndexedDB(function (db) {
          studysetsObjectStore = db.transaction(["studysets"], "readwrite").objectStore("studysets");
          var dbDeleteReq = studysetsObjectStore.delete(<eta>= data.localId </eta>);
          dbDeleteReq.onsuccess = function (event) {
            window.location.replace("/dashboard");
          }
          dbDeleteReq.onerror = function (error) {
            console.error(error);
            alert("indexeddb error while trying to delete local studyset")
          }
        })
      })
    </script>
    <eta> } </eta>
    <script>
      var flashcardsIndex = 0;
      function flashcardsFlip() {
        document.getElementById("flashcard").classList.toggle("flip");
      }
      document.getElementById("flashcard").addEventListener("click", flashcardsFlip);
      document.getElementById("flashcards-flip-button").addEventListener("click", flashcardsFlip);
      
      function flashcardsChange() {
        var termsList = document.getElementById("terms-table").children[0];
        document.getElementById("flashcard-front").innerText = termsList.children[flashcardsIndex + 1].children[0].innerText
        document.getElementById("flashcard-back").innerText = termsList.children[flashcardsIndex + 1].children[1].innerText
        document.getElementById("flashcards-count").innerText = (flashcardsIndex + 1) + "/" + (termsList.children.length - 1);
      }

      function flashcardsNext() {
        if (flashcardsIndex < (document.getElementById("terms-table").children[0].children.length - 2)) {
          flashcardsIndex += 1
          flashcardsChange()
        }
      }
      document.getElementById("flashcards-next-button").addEventListener("click", flashcardsNext);

      function flashcardsPrev() {
        if (flashcardsIndex > 0) {
          flashcardsIndex -= 1
          flashcardsChange()
        }
      }
      document.getElementById("flashcards-prev-button").addEventListener("click", flashcardsPrev);

      /* the modal's html is the same for local and authed */
      if (document.getElementById("delete-button")) {
        document.getElementById("delete-button").addEventListener("click", function () {
          document.getElementById("delete-modal").classList.remove("hide");
        })
        
        document.getElementById("delete-cancel-button").addEventListener("click", function () {
          document.getElementById("delete-modal").classList.add("hide");
        })
      }
      function maximizeFlashcards() {
        document.getElementById("title-and-menu-outer-div").classList.add("hide");
        document.getElementById("terms-and-stuff-outer-div").classList.add("hide");
        document.getElementById("footer-wave").classList.add("hide");
        document.getElementById("footer").classList.add("hide");

        document.getElementById("flashcards-unmaximize").classList.remove("hide");
      }
      function unmaximizeFlashcards() {
        document.getElementById("title-and-menu-outer-div").classList.remove("hide");
        document.getElementById("terms-and-stuff-outer-div").classList.remove("hide");
        document.getElementById("footer-wave").classList.remove("hide");
        document.getElementById("footer").classList.remove("hide");

        document.getElementById("flashcards-unmaximize").classList.add("hide");
      }
      document.getElementById("flashcards-maximize").addEventListener("click", maximizeFlashcards);
      document.getElementById("flashcards-unmaximize").addEventListener("click", unmaximizeFlashcards);
    </script>
    <eta> if (data?.studyset?.id) { </eta>
    <script>
      document.getElementById("delete-confirm-button").addEventListener("click", function () {
        fetch("/api/v0/studysets/<eta>= data.studyset.id </eta>", {
          method: "DELETE",
          credentials: "same-origin"
        }).then(function (rawResponse) {
          rawResponse.json().then(function (response) {
            if (response.error) {
              console.log(response)
              alert(response.error)
            } else {
              window.location.replace("/dashboard");
            }
          }).catch(function (error) {
            console.error(error);
            alert("json parsing fetch error");
            /* work in progress error msgs */
          })
        }).catch(function (error) {
          console.error(error);
          alert("fetch error")
          /* work in progress error messages? */
        })
      })
    </script>
    <eta> } </eta>
  </body>
</html>
